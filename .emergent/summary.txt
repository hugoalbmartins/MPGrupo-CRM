<analysis>**original_problem_statement:**
O utilizador solicitou a criação de uma aplicação de CRM para registo de parceiros e vendas, com as seguintes funcionalidades:

**PRODUCT REQUIREMENTS:**

1.  **Tipos de Utilizador e Permissões:**
    *   **Administrador:** Acesso total, dashboards com métricas globais, gestão total.
    *   **Backoffice (BO):** Regista e edita vendas, vê todas as vendas sem comissões.
    *   **Parceiro:** Regista e visualiza apenas as suas próprias vendas com comissões.
    *   **Parceiro - Comercial:** Regista e visualiza apenas as suas próprias vendas sem comissões.

2.  **Gestão de Parceiros (Apenas Admins):**
    *   Dados completos, incluindo NIF com validação CRC.
    *   Geração automática de código de parceiro (ex: ).
    *   Criação automática de utilizador associado.
    *   Anexar documentos ao parceiro.

3.  **Gestão de Operadoras (Apenas Admins):**
    *   Configuração de operadoras por âmbito.
    *   **Sistema de Comissões Complexo:** Multiplicadores e valores fixos por tipo de cliente/serviço, com patamares de comissão baseados no volume de vendas do parceiro para aquela operadora.

4.  **Registo de Vendas:**
    *   Formulário com campos condicionais baseados no âmbito da venda (Telecomunicações, Energia, Solar, Dual) com validações específicas (CPE, CUI).
    *   Geração automática de código de venda (ex: ).
    *   Gestão de estados da venda, com campos editáveis por Admin/BO.
    *   Anexar documentos ao registar a venda.

5.  **Sistema de Alertas:**
    *   Notificar Admins, BOs e o parceiro envolvido quando uma venda é registada, tem o seu estado alterado para Concluído ou Ativo, ou quando uma nota é adicionada.

6.  **Secção Formulários:**
    *   Permitir anexar documentos (PDFs) a cada operadora.
    *   Menu dinâmico que lista apenas as operadoras com formulários.
    *   Página para descarregar os formulários de cada operadora.

7.  **UI/UX:**
    *   Design profissional, dashboards coloridos.
    *   Tabelas com scroll horizontal em ecrãs pequenos.
    *   Diálogos (pop-ups) com cores claras para melhor legibilidade.

**User's preferred language**: Portuguese

**what currently exists?**
A aplicação full-stack (React + FastAPI + MongoDB) está funcional e implementa a maioria dos requisitos.
- **Backend:** Estrutura modular com  e ficheiros separados para modelos () e utilitários (). Inclui endpoints para utilizadores, parceiros, vendas, operadoras, dashboards por perfil, exportação para Excel, e um sistema de alertas. Uma estrutura de testes foi criada em .
- **Frontend:** Páginas funcionais para Login, Dashboard (com visão por perfil, filtro mensal e gráfico de 12 meses), Parceiros, Vendas, Operadoras, Utilizadores e Perfil. A interface permite a configuração complexa de comissões, upload de documentos em parceiros e vendas, edição de vendas, e visualização de alertas.
- **Funcionalidades Chave:** O sistema de comissões por patamares (calculado por parceiro e por operadora), a geração de códigos automáticos e a validação de NIF/CRC estão implementados e testados. O sistema de alertas está funcional. As melhorias de UI (scroll e clareza dos diálogos) foram implementadas.

**Last working item**:
    - Last item agent was working: O agente estava a iniciar a implementação da secção Formulários, que permite anexar documentos às operadoras e visualizá-los num menu dedicado.
    - Status: IN PROGRESS
    - Agent Testing Done: N
    - Which testing method agent to use? both
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - Issue 1: Concluir a implementação da secção Formulários (P0)
  - Issue 2: Instabilidade e timeouts intermitentes no frontend (P1)
  
  **Issues Detail:**
  - **Issue 1:** Concluir a implementação da secção Formulários
     - **Attempted fixes:** O agente começou a implementação no backend, adicionando a lógica para suportar o anexo de documentos às operadoras. O frontend ainda não foi implementado.
     - **Next debug checklist:**
        1. Verificar se o endpoint de upload para operadoras está completo no backend ().
        2. No frontend, modificar  para adicionar um botão e um diálogo que permita aos administradores fazer o upload de documentos para uma operadora.
        3. Modificar  para adicionar o item de menu Formulários com um submenu dinâmico que liste apenas as operadoras que têm documentos anexados.
        4. Criar uma nova página  para ser a página principal da secção, que mostra uma mensagem genérica e botões para as páginas de cada operadora.
        5. Criar uma página dinâmica (ou rota) para exibir os documentos de uma operadora específica para download.
        6. Adicionar as novas rotas em .
     - **Why fix this issue and what will be achieved with the fix?** É o último requisito explícito do utilizador, que centralizará o acesso a documentos importantes das operadoras.
     - **Status:** IN PROGRESS
     - **Is recurring issue?** N
     - **Should Test frontend/backend/both after fix?** both
     - **Blocked on other issue:** None

  - **Issue 2:** Instabilidade e timeouts intermitentes no frontend
     - **Attempted fixes:** O agente reiniciou o serviço do frontend quando encontrou problemas (página preta, timeouts em screenshots). No entanto, não foi feita uma investigação aprofundada da causa.
     - **Next debug checklist:**
        1. Após completar uma funcionalidade, executar vários testes de screenshot em diferentes páginas (, , ) para garantir que a aplicação carrega de forma consistente.
        2. Se um timeout ou ecrã preto ocorrer, verificar a consola do browser (através do log do screenshot) por erros de React/JavaScript.
        3. Analisar o código recentemente adicionado às páginas  e , pois os problemas começaram após grandes modificações nestes ficheiros (adição de múltiplos diálogos, estados e handlers de eventos).
     - **Why fix this issue and what will be achieved with the fix?** Garante que a aplicação é estável e usável em produção, resolvendo potenciais erros de renderização ou performance no frontend.
     - **Status:** NOT STARTED
     - **Is recurring issue?** Y
     - **Should Test frontend/backend/both after fix?** frontend
     - **Blocked on other issue:** None

**In progress Task List**:
- **Task 1**: Implementação da secção Formulários
     - **Where to resume**: O backend foi preparado. O próximo passo é focar no frontend: modificar a página  para permitir o upload e depois criar a nova secção de menu e páginas em  e .
     - **What will be achieved with this?** A aplicação terá uma secção dedicada para os utilizadores descarregarem formulários e documentos oficiais de cada operadora.
     - **Status:** IN PROGRESS
     - **Should Test frontend/backend/both after fix?** both
     - **Blocked on something:** None

**Upcoming and Future Tasks**
- Após a conclusão da secção Formulários, todos os requisitos iniciais do utilizador terão sido abordados. Os próximos passos serão baseados em novo feedback do utilizador.

**Completed work in this session**
- **Sistema de Comissões (Issue 1):** Implementado e refinado o complexo sistema de comissões, com patamares por parceiro e por operadora.
- **Dashboards por Perfil (Issue 2):** Implementados dashboards específicos para cada tipo de utilizador (Admin, BO, Parceiro), com filtro mensal e um gráfico de evolução dos últimos 12 meses.
- **Geração de Códigos (Issue 3):** Validada e confirmada a funcionalidade de geração automática de códigos para parceiros e vendas.
- **Validação NIF/CRC (Issue 4):** Implementada a validação no backend e frontend para NIFs de empresas (iniciados por 5).
- **Sistema de Alertas:** Criado um sistema de notificações completo (backend e frontend) para eventos importantes nas vendas.
- **Gestão de Documentos:** Implementada a funcionalidade de anexar documentos na criação/edição de parceiros e na criação de vendas.
- **Edição de Vendas:** Adicionada a capacidade de Admins/BOs editarem vendas e adicionarem notas através da UI.
- **Exportação para Excel:** Implementada a funcionalidade de exportar vendas para um ficheiro Excel, com filtro de datas.
- **Melhorias de UI/UX:** As tabelas foram tornadas responsivas com scroll horizontal e o design dos diálogos foi tornado mais claro e legível.
- **Refatoração e Testes:** A estrutura do backend foi refatorada para melhor organização e foram criados 11 testes unitários para a lógica de comissões.

**Earlier issues found/mentioned but not fixed**
N/A

**Known issue recurrence from previous fork**
N/A

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, Pydantic, Motor (MongoDB async), Passlib, JWT, openpyxl, pandas.
- **Frontend:** React, React Router, Axios, TailwindCSS, Recharts.
- **Database:** MongoDB.
- **Architecture:** API RESTful (FastAPI) e Single Page Application (React).

**key DB schema**
- **User:** uid=0(root) gid=0(root) groups=0(root), , , , , , .
- **Partner:** uid=0(root) gid=0(root) groups=0(root), , , , , ,  (List[str]).
- **Operator:** uid=0(root) gid=0(root) groups=0(root), , , , ,  (List[str]).
- **Sale:** uid=0(root) gid=0(root) groups=0(root), , , , , , , , .
- **Alert:** uid=0(root) gid=0(root) groups=0(root), , , , , .
- **Note:** uid=0(root) gid=0(root) groups=0(root), , , , .

**changes in tech stack**
-  foi adicionado para gráficos no frontend.
- , ,  foram usados para a exportação de Excel no backend.

**All files**
- : Modificado extensivamente para adicionar endpoints de dashboard por perfil, exportação de Excel, sistema de alertas e edição de vendas.
- : A função  foi refatorada várias vezes para corresponder à lógica de patamares por parceiro/operadora. Adicionada .
- : Adicionado o modelo  e o campo  aos modelos  e .
- : Nova diretoria com testes para a lógica de comissões.
- : Completamente reescrito para suportar visões por perfil, filtro de data e o novo gráfico de 12 meses.
- : Modificado para adicionar a coluna de comissão, botões/diálogos para edição de vendas e adição de notas, UI para exportação de Excel e campo de upload de ficheiros na criação.
- : Modificado para adicionar validação de NIF/CRC em tempo real e a UI para gestão de documentos do parceiro.
- : Modificado para integrar o componente de configuração de comissões.
- : Novo componente para a UI de configuração de comissões.
- : Modificado para integrar o sistema de alertas (ícone, contador e painel).
- : Nova página para listar todos os alertas do utilizador.
- : Adicionada a rota para a página .
- : Adicionados estilos para responsividade das tabelas (scroll) e para melhorar a visibilidade dos diálogos.
- : Novo documento de arquitetura.
- : Atualizado ao longo da sessão.

**Areas that need refactoring**:
- O frontend, especialmente os ficheiros  e , tornaram-se muito grandes e complexos. Extrair os diálogos (modals) e outras lógicas para componentes separados poderia melhorar a manutenção.

**key api endpoints**
- 
- , 
- ,  (PUT, GET), 
- , 
- , ,  (aceitam query params  e )
- 
- , , 

**Critical Info for New Agent**
- A lógica de cálculo de comissões é o coração do sistema: os patamares são definidos por operadora e aplicados com base na contagem de vendas de um parceiro **para essa operadora específica**. Os contadores são independentes entre operadoras.
- O frontend tem mostrado sinais de instabilidade (timeouts, ecrãs pretos) após grandes modificações. É crucial testar a UI de forma consistente após cada alteração.
- A tarefa atualmente em progresso é a secção Formulários. O trabalho de backend foi iniciado, mas toda a implementação do frontend ainda está pendente.

**documents created in this job**
- 
- 
- 

**Last 5 User Messages and any pending user messages**
1.  **User (Msg 383):** Solicitou melhorias na UI: tabelas com scroll horizontal para ecrãs pequenos e diálogos (pop-ups) com cores mais claras. **Status:** Implementado.
2.  **User (Msg 412):** Solicitou um sistema de alertas para novas vendas, alterações de estado e novas notas, e a capacidade de anexar documentos no registo de vendas. **Status:** Implementado.
3.  **User (Msg 475):** Solicitou a funcionalidade Formulários: anexar PDFs às operadoras e mostrá-los num menu e página dedicados. **Status:** Em progresso.
4.  **User (Msg 282):** Disse para proceder com o resto dos procedimentos em falta (após o agente se ter bloqueado na exportação para excel). **Status:** Concluído.
5.  **User (Msg 331):** Disse para proceder restantes pendentes. **Status:** Concluído.

**Project Health Check:**
- **Broken:** Ocasionalmente, o frontend falha ao carregar ou responde com timeouts, especialmente após modificações em componentes complexos como . Isto sugere potenciais problemas de performance ou erros de renderização que precisam de ser investigados.
- **Mocked:** N/A.

**Testing status**
  - Testing agent used after significant changes: YES (usado no final da sessão, corrigiu um erro de JSX e validou o fluxo geral).
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: []
  - Known regressions: N/A

**Credentials to test flow:**
- **Admin Login:**
  - **Email:** 
  - **Password:** 

**What agent forgot to execute**
- O agente não investigou a fundo as causas dos timeouts e ecrãs pretos no frontend, optando por reiniciar os serviços e seguir em frente. A estabilidade geral da UI precisa de ser confirmada.</analysis>
